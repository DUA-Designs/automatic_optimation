name: Image Resize Optimization

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resize:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      - name: Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends libvips-tools

      - name: Install npm dependencies
        run: |
          npm install sharp glob mkdirp

      - name: Prepare optimized folder
        run: mkdir -p optimized

      - name: Copy repo into optimized directory
        run: |
          rsync -a --exclude='.git' --exclude='node_modules' --exclude='optimized' ./ optimized/
          rm -rf optimized/.github || true

      - name: Run image resize script
        working-directory: optimized
        run: |
          if [ -f js/resize-images.js ]; then
            node js/resize-images.js
          else
            echo "resize-images.js not found inside optimized/js"
            exit 1
          fi

      - name: Create optimization report
        run: |
          cd optimized
          REPORT=optimization-report.md
          echo "# Image Resize Report" > "$REPORT"
          echo "Generated: $(date -u +"%Y-%m-%d %H:%M:%SZ")" >> "$REPORT"
          echo "" >> "$REPORT"
          echo "## File Counts" >> "$REPORT"
          echo "- Total images: $(find . -type f -iregex '.*\\.\(jpg\|jpeg\|png\|webp\)' | wc -l)" >> "$REPORT"
          for s in 320 480 768 1024 1440; do
            echo "- ${s}w: $(find . -path \"*/${s}w/*\" -type f | wc -l)" >> "$REPORT"
          done

      - name: Upload resized images
        uses: actions/upload-artifact@v4
        with:
          name: resized-images
          path: optimized/**

      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: resize-report
          path: optimized/optimization-report.md
